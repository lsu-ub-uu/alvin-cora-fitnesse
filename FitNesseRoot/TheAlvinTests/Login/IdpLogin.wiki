---
Help: A test that checks that idpLogin works as expected
Test
---
!contents -R2 -g -p -f -h
| import |
| se.uu.ub.cora.fitnesseintegration |

!| script | SystemUrl |
| setUrl | ${systemUnderTestUrl} |
| setAppTokenVerifierUrl | ${appTokenVerifierUrl} |
| setIdpLoginUrl | ${idpLoginUrl} |
| setGatekeeperServerUrl | ${gatekeeperServerUrl} |

!| script | DependencyProvider |
| setHttpHandlerFactoryClassName | se.uu.ub.cora.httphandler.HttpHandlerFactoryImp |
| setJsonToDataFactoryClassName | se.uu.ub.cora.clientdata.converter.jsontojava.JsonToDataConverterFactoryImp |

!1 !-IdpLoginTest-!
IdpLogin is in test and production secured by apache and common login systems and can not be accessed without a successful login into the local idp. We are expecting the parameter eppn to be present when the user is allowed past apache and can access the idpLogin server. This eppn sent on to gatekeeperServer that looks for a user in the database with a matching eppn. Gatekeeper returns an authtoken for the user, and stores the user in the currently logged in users under the returned authtoken. If no user is found for an eppn an authtoken is created for and returned for the guest user.

!2 Fetch authTokens using idpLogin
!***> Get authTokens from idpLogin server

!| IdpLoginServletFixture |
| EPPN | getAuthTokenForEPPN? | getIdFromLogin? | getResponseCode? | getAuthToken? | getValidForNoSeconds? | getDeleteUrl? |
| fitnesseAdminDb@user.uu.se | | fitnesseAdminDb@user.uu.se | OK | $adminAuthToken= | | ${tokenLogoutURL}/rest/56 |
| fitnesseUserDb@user.uu.se | | fitnesseUserDb@user.uu.se | OK | $userAuthToken= | | ${tokenLogoutURL}/rest/57 |
| userNotInDb@user.uu.se | | | OK | | | ${tokenLogoutURL}/rest/coraUser:5368244264733286 |

*!
!2 Test with new texts to show that we can use our authToken and be our user
!***> Create data of recordType text (textSystemOne)

!| RecordEndpointFixture |
| authToken | type | json | testCreateRecord? | getStatusType? |
| $userAuthToken | textSystemOne | {"name":"text","children":[{"name":"recordInfo","children":[{"name":"id","value":"myAuthText"},{"children":[{"name":"linkedRecordType","value":"system"},{"name":"linkedRecordId","value":"cora"}],"name":"dataDivider"}]},{"name":"textPart","attributes":{"type":"default","lang":"sv"} ,"children":[{"name":"text","value":"Min svenska text"}]}]} | =~/"name":"linkedRecordId",\s*"value":"57"/ | CREATED |

*!
!***> Logout

!| AppTokenEndpointFixture |
| userId | authTokenToLogOut | removeAuthTokenForUser? | getStatusType? |
| 57 | $userAuthToken | | OK |

*!
!2 Test with new texts to show that authToken is not valid after logout
!***> Create data of recordType text (textSystemOne)

!| RecordEndpointFixture |
| authToken | type | json | testCreateRecord? | getStatusType? |
| $userAuthToken | textSystemOne | {"name":"text","children":[{"name":"recordInfo","children":[{"name":"id","value":"myAuthText"},{"children":[{"name":"linkedRecordType","value":"system"},{"name":"linkedRecordId","value":"cora"}],"name":"dataDivider"}]},{"name":"textPart","attributes":{"type":"default","lang":"sv"} ,"children":[{"name":"text","value":"Min svenska text"}]}]} | | UNAUTHORIZED |

*!
!2 Clean up created data
!***> Clean up created data

!| RecordEndpointFixture |
| authToken | type | id | testDeleteRecord? | getStatusType? |
| $adminAuthToken | textSystemOne | myAuthText | | OK |

*!
